<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Redeteki</title>
  <link rel="icon" href="./img/blocksoft.png" type="image/png">
  <style>
    body { background-color: rgb(32, 28, 28); font-family: Arial, sans-serif; text-align: center; color: white; }
    #login, #chat-container { margin: 20px auto; width: 600px; border: 1px solid #ccc; padding: 15px; border-radius: 8px; display: none; background: #222; }
    #chat { width: 90%; height: 400px; border: 1px solid #555; margin: 10px auto; padding: 10px; overflow-y: auto; text-align: left; background: #111; border-radius: 8px; }
    input { margin: 10px 0; padding: 10px; width: 90%; border-radius: 5px; border: none; }
    button { padding: 8px 15px; cursor: pointer; border: none; border-radius: 5px; background: #4CAF50; color: white; }
    .error { color: red; font-size: 14px; }
    #counter { font-size: 13px; margin-top: -5px; color: #bbb; }
    .message { display: flex; align-items: center; margin: 5px 0; }
    .message img { border-radius: 8px; margin-right: 8px; max-width: 200px; max-height: 200px; }
    #users-list { text-align: left; background: #111; padding: 10px; border-radius: 8px; margin-top: 15px; }
    #users-list h4 { margin: 0 0 5px 0; font-size: 16px; }
    #users-list ul { list-style: none; padding: 0; margin: 0; }
    #users-list li { margin: 4px 0; display: flex; align-items: center; }
    #users-list li img { width: 20px; height: 20px; border-radius: 50%; margin-right: 6px; }
    #logo1 { position: absolute; top: 60px; left: 170px; }
  </style>
</head>
<body>
  <h2>Redeteki</h2>

  <!-- Tela de login -->
  <img src="./img/niravergonha.png" width="300px" id="logo1">
  <div id="login">
    <h3>Entrar</h3>
    <input type="text" id="username" placeholder="Usuário (máx 28 caracteres)">
    <input type="password" id="password" placeholder="Senha">
    <input type="file" id="avatarFile" accept="image/*">
    <button onclick="fazerLogin()">Login</button>
    <p class="error" id="loginError"></p>
  </div>

  <!-- Tela do chat -->
  <div id="chat-container">
    <div id="chat"></div>
    <input type="text" id="msg" placeholder="Digite uma mensagem... (máx 70)">
    <div id="counter">0/70</div>
    <button onclick="enviar()">Enviar</button>
    <br>
    <input type="file" id="fileInput">
    <button id="foto1" onclick="enviarArquivo()">Enviar Arquivo</button>

    <!-- Lista de usuários -->
    <div id="users-list">
      <h4>Usuários online (0)</h4>
      <ul id="users"></ul>
    </div>
  </div>

  <script>
    const socket = new WebSocket("wss://tkback.onrender.com");

    const loginDiv = document.getElementById("login");
    const chatDiv = document.getElementById("chat-container");
    const chat = document.getElementById("chat");
    const msgInput = document.getElementById("msg");
    const loginError = document.getElementById("loginError");
    const counter = document.getElementById("counter");
    const usersList = document.getElementById("users");
    const usersTitle = document.querySelector("#users-list h4");

    let username = null;

    socket.onopen = () => { loginDiv.style.display = "block"; };

    socket.onmessage = (event) => {
      const data = JSON.parse(event.data);

      if (data.type === "error") {
        loginError.textContent = data.text;
      }

      if (data.type === "login_success") {
        username = data.username;
        loginDiv.style.display = "none";
        chatDiv.style.display = "block";
      }

      if (data.type === "message") {
        const div = document.createElement("div");
        div.classList.add("message");
        div.innerHTML = `<img src="${data.avatar}" alt="pfp"><span>${data.text}</span>`;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
      }

      if (data.type === "user_list") {
        usersList.innerHTML = "";
        data.users.forEach(u => {
          const li = document.createElement("li");
          li.innerHTML = `<img src="${u.avatar}" alt="pfp"><span>${u.username}</span>`;
          usersList.appendChild(li);
        });
        usersTitle.textContent = `Usuários online (${data.users.length})`;
      }
    };

    function fazerLogin() {
      const user = document.getElementById("username").value.trim();
      const pass = document.getElementById("password").value.trim();
      const avatarFile = document.getElementById("avatarFile").files[0];

      if (!user || !pass) {
        loginError.textContent = "Preencha usuário e senha!";
        return;
      }

      if (avatarFile) {
        const reader = new FileReader();
        reader.onload = () => {
          const base64Data = reader.result.split(",")[1];
          socket.send(JSON.stringify({ 
            type: "login", 
            username: user, 
            password: pass, 
            avatarFile: { name: avatarFile.name, data: base64Data }
          }));
        };
        reader.readAsDataURL(avatarFile);
      } else {
        socket.send(JSON.stringify({ 
          type: "login", 
          username: user, 
          password: pass, 
          avatar: "https://i.imgur.com/6VBx3io.png" 
        }));
      }
    }

    function enviar() {
      if (msgInput.value && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({ type: "message", text: msgInput.value }));
        msgInput.value = "";
        counter.textContent = "0/70";
      }
    }

    msgInput.addEventListener("keypress", (e) => { if (e.key === "Enter") enviar(); });

    msgInput.addEventListener("input", () => {
      let len = msgInput.value.length;
      if (len > 70) {
        msgInput.value = msgInput.value.substring(0, 70);
        len = 70;
      }
      counter.textContent = `${len}/70`;
    });

    async function enviarArquivo() {
      const fileInput = document.getElementById("fileInput");
      if (!fileInput.files.length) return;
      const file = fileInput.files[0];

      const reader = new FileReader();
      reader.onload = () => {
        const base64Data = reader.result.split(",")[1];
        socket.send(JSON.stringify({ type: "file", name: file.name, data: base64Data }));
      };
      reader.readAsDataURL(file);
    }
  </script>
</body>
</html>
