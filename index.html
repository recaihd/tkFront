<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Redeteki</title>
  <link rel="description" content="Redeteki, um blog com chats em tempo real">
  <link rel="icon" href="./img/redetekiIcon.png" type="image/png">
  <style>
    body { 
      background-color: rgb(32, 28, 28);
      font-family: Arial, sans-serif;
      text-align: center; 
      color: white;
    }

    #login, #chat-container, #loading {
      margin: 20px auto;
      width: 600px;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 8px;
      display: none;
      background: #222;
    }

    #loading {
      background: none;
      border: none;
    }

    #loading img {
      width: 120px;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }

    #chat { 
      width: 90%; 
      height: 400px;
      border: 1px solid #555;
      margin: 10px auto;
      padding: 10px;
      overflow-y: auto;
      text-align: left; 
      background: #111;
      border-radius: 8px;
    }

    input { 
      margin: 10px 0;
      padding: 10px; 
      width: 90%;
      border-radius: 5px;
      border: none;
    }

    button {
      padding: 8px 15px; 
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background: #4CAF50;
      color: white;
    }

    .error { 
      color: red;
      font-size: 14px;
    }

    #counter {
      font-size: 13px;
      margin-top: -5px; 
      color: #bbb; 
    }

    #foto1 {
      display: inline-block;
      background-size: cover;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    #foto1:hover { opacity: 0.8; }
    #fileName { margin-left: 10px; font-size: 14px; color: #ccc; }

    .message { display: flex; align-items: center; margin: 5px 0; }
    .message img { border-radius: 8px; margin-right: 8px; max-width: 200px; max-height: 100px; }

    #users-list { text-align: left; background: #111; padding: 10px; border-radius: 8px; margin-top: 15px; }
    #users-list h4 { margin: 0 0 5px 0; font-size: 16px; }
    #users-list ul { list-style: none; padding: 0; margin: 0; }
    #users-list li { margin: 4px 0; display: flex; align-items: center; }
    #users-list li img { width: 20px; height: 20px; border-radius: 50%; margin-right: 6px; }

    #logo1 { position: absolute; top: 28px; left: 695px; }
    #redetekih2 { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); }
  </style>
</head>
<body>
  <h2 id="redetekih2">Redeteki</h2>
  <br><br><br><br>

  <img src="./img/redetekiIcon.png" id="logo1" width="50px">

  <!-- Tela de carregamento -->
  <div id="loading">
    <img src="./img/megucarregando.png" alt="Carregando...">
    <p>Conectando ao servidor...</p>
  </div>

  <!-- Tela de login -->
  <div id="login">
    <h3>Entrar</h3>
    <input type="text" id="username" placeholder="Usuário (máx 28 caracteres)">
    <input type="password" id="password" placeholder="Senha">

    <input type="file" id="avatarFile" accept="image/*" hidden>
    <label for="avatarFile" id="foto1">Escolher arquivo</label>
    <span id="fileName">Nenhum arquivo escolhido</span>

    <br><br>
    <button onclick="fazerLogin()">Login</button>
    <p class="error" id="loginError"></p>
  </div>

  <!-- Tela do chat -->
  <div id="chat-container">
    <div id="chat"></div>
    <input type="text" id="msg" placeholder="Digite uma mensagem... (máx 70)">
    <div id="counter">0/70</div>
    <button onclick="enviar()">Enviar</button>

    <div id="users-list">
      <h4>Usuários online (0)</h4>
      <ul id="users"></ul>
    </div>
  </div>

  <script>
  const loginDiv = document.getElementById("login");
  const chatDiv = document.getElementById("chat-container");
  const loadingDiv = document.getElementById("loading");
  const chat = document.getElementById("chat");
  const msgInput = document.getElementById("msg");
  const loginError = document.getElementById("loginError");
  const counter = document.getElementById("counter");
  const usersList = document.getElementById("users");
  const usersTitle = document.querySelector("#users-list h4");

  let username = null;

  const socket = new WebSocket("wss://tkback.onrender.com");

  // mostra loading enquanto conecta
  loadingDiv.style.display = "block";

  socket.addEventListener("open", () => {
    const savedUser = localStorage.getItem("username");
    const savedPass = localStorage.getItem("password");
    const savedAvatar = localStorage.getItem("avatar");

    if (savedUser && savedPass) {
      socket.send(JSON.stringify({
        type: "login",
        username: savedUser,
        password: savedPass,
        avatar: savedAvatar || "./img/redetekiIcon2.png"
      }));
    }
  });

  socket.onmessage = (event) => {
    const data = JSON.parse(event.data);

    if (data.type === "login_required") {
      loadingDiv.style.display = "none";
      loginDiv.style.display = "block";
      chatDiv.style.display = "none";
    }

    if (data.type === "error") {
      loginError.textContent = data.text;
    }

    if (data.type === "login_success") {
      username = data.username;
      loadingDiv.style.display = "none";
      loginDiv.style.display = "none";
      chatDiv.style.display = "block";

      const pass = document.getElementById("password").value.trim();
      const avatarFile = document.getElementById("avatarFile").files[0];
      localStorage.setItem("username", username);
      localStorage.setItem("password", pass);
      if (!avatarFile) {
        localStorage.setItem("avatar", "./img/redetekiIcon2.png");
      }
    }

    if (data.type === "message") {
      const div = document.createElement("div");
      div.classList.add("message");
      div.innerHTML = `<img src="${data.avatar}" alt="pfp"><span>${data.text}</span>`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    if (data.type === "user_list") {
      usersList.innerHTML = "";
      data.users.forEach(u => {
        const li = document.createElement("li");
        li.innerHTML = `<img src="${u.avatar}" alt="pfp"><span>${u.username}</span>`;
        usersList.appendChild(li);
      });
      usersTitle.textContent = `Usuários online (${data.users.length})`;
    }
  };

  function fazerLogin() {
    const user = document.getElementById("username").value.trim();
    const pass = document.getElementById("password").value.trim();
    const avatarFile = document.getElementById("avatarFile").files[0];

    if (!user || !pass) {
      loginError.textContent = "Preencha usuário e senha!";
      return;
    }

    if (avatarFile) {
      const reader = new FileReader();
      reader.onload = () => {
        const base64Data = reader.result.split(",")[1];
        socket.send(JSON.stringify({ 
          type: "login", 
          username: user, 
          password: pass, 
          avatarFile: { name: avatarFile.name, data: base64Data }
        }));
      };
      reader.readAsDataURL(avatarFile);
    } else {
      socket.send(JSON.stringify({ 
        type: "login", 
        username: user, 
        password: pass, 
        avatar: "./img/redetekiIcon2.png" 
      }));
    }
  }

  function enviar() {
    if (msgInput.value && socket.readyState === WebSocket.OPEN) {
      socket.send(JSON.stringify({ type: "message", text: msgInput.value }));
      msgInput.value = "";
      counter.textContent = "0/70";
    }
  }

  msgInput.addEventListener("keypress", (e) => { if (e.key === "Enter") enviar(); });

  msgInput.addEventListener("input", () => {
    let len = msgInput.value.length;
    if (len > 70) {
      msgInput.value = msgInput.value.substring(0, 70);
      len = 70;
    }
    counter.textContent = `${len}/70`;
  });

  setInterval(() => {
    if (socket.readyState === WebSocket.OPEN) {
      socket.send(JSON.stringify({ type: "ping" }));
    }
  }, 25000);
  </script>
</body>
</html>
